<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Weather Stations Map</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #topbar {
            padding: 10px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #map {
            height: calc(100% - 52px);
        }

        input[type="text"] {
            width: min(900px, 70vw);
            padding: 8px;
        }

        button {
            padding: 8px 12px;
        }

        #status {
            font-family: system-ui, sans-serif;
            font-size: 14px;
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <div id="topbar">
        <input id="apiUrl" type="text" placeholder="Paste API URL that returns stations JSON…" />
        <button id="loadBtn">Load</button>
        <span id="status"></span>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const statusEl = document.getElementById("status");
        const apiUrlEl = document.getElementById("apiUrl");
        const loadBtn = document.getElementById("loadBtn");

        const map = L.map("map").setView([0, 0], 2);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const markersLayer = L.layerGroup().addTo(map);

        function setStatus(msg) { statusEl.textContent = msg; }

        // Try to interpret a station object with flexible field names
        function getLatLon(feature) {
  const coords = feature?.geometry?.coordinates;
  if (!Array.isArray(coords) || coords.length < 2) return null;

  const lon = Number(coords[0]);
  const lat = Number(coords[1]);
  if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;

  return [lat, lon]; // Leaflet wants [lat, lon]
}


        function stationLabel(st) {
            return st.name ?? st.stationName ?? st.id ?? st.stationId ?? "Station";
        }

        async function loadStations() {
            const url = apiUrlEl.value.trim();
            if (!url) return setStatus("Paste an API URL first.");

            setStatus("Loading…");
            markersLayer.clearLayers();

            let data;
            try {
                const res = await fetch(url, {
                    // If your endpoint needs headers, add them here:
                    // headers: { "Authorization": "Bearer …" }
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                data = await res.json();
            } catch (e) {
                setStatus(`Fetch failed: ${e.message}`);
                return;
            }

            // Accept either an array directly, or an object containing an array
            const stations = data.features; // since you said it's always here

            if (!stations) {
                setStatus("JSON didn’t look like an array of stations. Check console.");
                console.log("Response JSON:", data);
                return;
            }

            const points = [];
            let plotted = 0;

            for (const st of stations) {
                const ll = getLatLon(st);
                if (!ll) continue;

                points.push(ll);
                plotted++;

                L.marker(ll)
                    .bindPopup(`<strong>${stationLabel(st)}</strong><br/>${ll[0].toFixed(5)}, ${ll[1].toFixed(5)}`)
                    .addTo(markersLayer);
            }

            if (!plotted) {
                setStatus("No stations with lat/lon found. Check field names in JSON.");
                console.log("Stations sample:", stations.slice(0, 3));
                return;
            }

            setStatus(`Plotted ${plotted} stations.`);
            const bounds = L.latLngBounds(points);
            map.fitBounds(bounds.pad(0.2));
        }

        loadBtn.addEventListener("click", loadStations);
    </script>
</body>

</html>