<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Weather Stations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
  </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map("map").setView([-33.645239, 150.556535], 11);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap contributors",
    maxZoom: 19
  }).addTo(map);


  const layer = L.layerGroup().addTo(map);

  const startX = 1879;
  const startY = 1226;

  const WINDOW_MS = 15 * 60 * 1000;
  const cache = new Map();

  function fToC(f) { return (f - 32) * 5 / 9; }

  function getLatLon(f) {
    const c = f?.geometry?.coordinates;
    if (!Array.isArray(c) || c.length < 2) return null;
    return [c[1], c[0]];
  }

  function humidityToColor(h) {
  if (typeof h !== "number") return "#888";

  const hMin = 50;   // red
  const hMax = 95;   // blue
  const v = Math.min(hMax, Math.max(hMin, h));
  const f = (v - hMin) / (hMax - hMin);

  // red (255,0,0) → blue (0,0,255)
  const r = Math.round(255 * (1 - f));
  const g = 0;
  const b = Math.round(255 * f);

  return `rgb(${r},${g},${b})`;
}

  function floorToQuarterHour(ms) {
    const d = new Date(ms);
    d.setSeconds(0, 0);
    d.setMinutes(d.getMinutes() - (d.getMinutes() % 15));
    return d.getTime();
  }

  async function fetchFeatures(startMs, endMs) {
    const key = `${startMs}-${endMs}`;
    if (cache.has(key)) return cache.get(key);

    let features = [];
    for (let x = startX; x <= startX + 2; x++) {
      for (let y = startY; y <= startY + 2; y++) {
        const url =
          `https://api.weather.com/v2/vector-api/products/614/features` +
          `?x=${x}&y=${y}&lod=12&apiKey=e1f10a1e78da46f5b10a1e78da96f525` +
          `&tile-size=512&time=${startMs}-${endMs}`;

        const r = await fetch(url);
        const j = await r.json();
        features = features.concat(j.features);
      }
    }
    cache.set(key, features);
    return features;
  }

  function mostRecentPerStation(features, startMs, endMs) {
    const byId = new Map();

    for (const f of features) {
      const id = f?.id || f?.properties?.id;
      const vt = f?.properties?.validTime;
      if (!id || typeof vt !== "number") continue;
      if (!f.properties?.humidity || typeof f.properties.humidity !== "number") continue;

      // keep only readings in the requested 15-minute window
      if (vt < startMs || vt > endMs) continue;
      

      const prev = byId.get(id);
      if (!prev || vt > prev.properties.validTime) {
        byId.set(id, f);
      }
    }

    return [...byId.values()];
  }

  async function loadData() {
    // end time locked to :00, :15, :30, :45
    const end = floorToQuarterHour(Date.now());
    const start = end - WINDOW_MS;

    const bucket = await fetchFeatures(start, end);
    const features = mostRecentPerStation(bucket, start, end);

    layer.clearLayers();
    const pts = [];

    for (const f of features) {
      const ll = getLatLon(f);
      if (!ll) continue;

      const p = f.properties || {};
      const t = typeof p.tempf === "number" ? fToC(p.tempf) : null;
      const h = typeof p.humidity === "number" ? p.humidity : null;

      L.circleMarker(ll, {
        radius: 9,
        fillColor: humidityToColor(h),
        color: "#000",
        weight: 0,
        fillOpacity: 0.85
      })
      .bindPopup(
        `<strong>${p.neighborhood ?? f.id}</strong><br>
         Temp: ${t !== null ? t.toFixed(1) : "—"} °C<br>
         Humidity: ${h} %`
      )
      .addTo(layer);

      pts.push(ll);
    }
  }

  loadData();
</script>

</body>
</html>
